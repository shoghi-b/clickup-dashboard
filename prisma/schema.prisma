// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ClickUp Team Member
model TeamMember {
  id              String        @id @default(cuid())
  clickupId       Int           @unique
  username        String
  email           String?
  profilePicture  String?
  role            String?

  // Work expectations
  expectedHoursPerDay   Float   @default(8.0)
  expectedHoursPerWeek  Float   @default(40.0)

  // Relationships
  timeEntries     TimeEntry[]
  dailySummaries  DailySummary[]
  weeklySummaries WeeklySummary[]
  kpiSummaries    MemberKPISummary[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([clickupId])
  @@index([email])
}

// ClickUp Time Entry
model TimeEntry {
  id              String        @id @default(cuid())
  clickupId       String        @unique

  // User reference
  teamMemberId    String
  teamMember      TeamMember    @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  // Time tracking
  duration        Int           // Duration in milliseconds
  startDate       DateTime
  endDate         DateTime?

  // Task/Project metadata
  taskId          String?
  taskName        String?
  projectId       String?
  projectName     String?
  listId          String?
  listName        String?
  spaceId         String?
  spaceName       String?

  // Logging metadata
  loggedAt        DateTime      // When the entry was created in ClickUp
  isBackfilled    Boolean       @default(false) // Whether logged after the work day

  // Billing/tags
  billable        Boolean       @default(false)
  tags            String?       // JSON array of tags

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([teamMemberId])
  @@index([startDate])
  @@index([taskId])
  @@index([projectId])
}

// Daily Summary for each team member
model DailySummary {
  id              String        @id @default(cuid())

  // User reference
  teamMemberId    String
  teamMember      TeamMember    @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  // Date
  date            DateTime      // The work day being summarized

  // Metrics
  totalHours      Float         // Total hours logged
  entryCount      Int           // Number of time entries
  sameDayEntries  Int           // Entries logged same day
  backfilledEntries Int         // Entries logged later

  // Compliance
  complianceStatus String       // "FULLY_COMPLIANT", "PARTIALLY_COMPLIANT", "NON_COMPLIANT"
  meetsMinimum    Boolean       // >= 6 hours
  isSameDay       Boolean       // Logged same day

  // Utilization
  utilizationPercent Float       // (totalHours / expectedHours) * 100

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([teamMemberId, date])
  @@index([date])
  @@index([complianceStatus])
}

// Weekly Summary for each team member
model WeeklySummary {
  id              String        @id @default(cuid())

  // User reference
  teamMemberId    String
  teamMember      TeamMember    @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  // Week identification
  weekStartDate   DateTime      // Monday of the week
  weekEndDate     DateTime      // Friday of the week
  year            Int
  weekNumber      Int

  // Metrics
  totalHours      Float         // Total hours logged in week
  activeDays      Int           // Days with logged time (out of 5)
  entryCount      Int           // Total entries
  backfilledCount Int           // Backfilled entries

  // Compliance
  complianceStatus String       // "FULLY_COMPLIANT", "PARTIALLY_COMPLIANT", "NON_COMPLIANT"
  meetsActiveThreshold Boolean  // >= 4 out of 5 days
  limitedBackfilling Boolean    // Acceptable backfill ratio

  // Utilization
  utilizationPercent Float       // (totalHours / expectedWeeklyHours) * 100
  utilizationCategory String     // "UNDER", "HEALTHY", "OVER"

  // Risk signals
  hasUnderLogging Boolean       @default(false)
  hasOverwork     Boolean       @default(false)
  hasExcessiveBackfill Boolean  @default(false)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([teamMemberId, year, weekNumber])
  @@index([weekStartDate])
  @@index([complianceStatus])
}

// Configuration for work expectations and settings
model Configuration {
  id              String        @id @default(cuid())
  key             String        @unique
  value           String        // JSON value
  description     String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

// Sync log to track API sync operations
model SyncLog {
  id              String        @id @default(cuid())
  syncType        String        // "TEAM_MEMBERS", "TIME_ENTRIES", "FULL", "ATTENDANCE"
  status          String        // "SUCCESS", "FAILED", "PARTIAL"
  startedAt       DateTime
  completedAt     DateTime?
  recordsProcessed Int          @default(0)
  errorMessage    String?

  createdAt       DateTime      @default(now())

  @@index([syncType])
  @@index([status])
  @@index([startedAt])
}

// Attendance Record from uploaded attendance sheet
model AttendanceRecord {
  id              String        @id @default(cuid())

  // Employee information
  employeeName    String        // Name from attendance sheet
  employeeCode    String?       // Employee code if available

  // Date
  date            DateTime      // The work day

  // Time tracking
  firstIn         String?       // First IN time (HH:mm format)
  lastOut         String?       // Last OUT time (HH:mm format)

  // Calculated fields
  totalHours      Float         @default(0) // Total hours in office
  status          String        // "PRESENT", "ABSENT", "PARTIAL"

  // Raw data for reference
  shift           String?       // Shift type (G, X, etc.)
  workPlusOT      String?       // Work+OT from sheet

  // Metadata
  uploadBatchId   String        // To track which upload this came from

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([employeeName, date, uploadBatchId])
  @@index([employeeName])
  @@index([date])
  @@index([status])
  @@index([uploadBatchId])
}

// Attendance Upload tracking
model AttendanceUpload {
  id              String        @id @default(cuid())

  // Upload metadata
  fileName        String
  fileSize        Int
  uploadedBy      String?       // User who uploaded (if auth is added)

  // Date range processed
  startDate       DateTime
  endDate         DateTime

  // Processing stats
  totalRecords    Int           @default(0)
  presentCount    Int           @default(0)
  absentCount     Int           @default(0)
  partialCount    Int           @default(0)

  // Status
  status          String        // "PROCESSING", "COMPLETED", "FAILED"
  errorMessage    String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([status])
  @@index([createdAt])
}

// Team KPI Summary - Aggregated accountability and capacity metrics
model TeamKPISummary {
  id              String        @id @default(cuid())

  // Period identification
  periodType      String        // "DAILY", "WEEKLY", "MONTHLY"
  periodStart     DateTime
  periodEnd       DateTime

  // Accountability KPIs
  attendanceComplianceRate    Float   @default(0)  // % of expected workdays with attendance
  timesheetComplianceRate     Float   @default(0)  // % of expected workdays with min hours logged
  presentNotLoggedCount       Int     @default(0)  // Count of members present but didn't log time

  // Capacity KPIs
  avgUtilization              Float   @default(0)  // Average utilization across team
  overCapacityCount           Int     @default(0)  // Members logging above expected hours
  underCapacityCount          Int     @default(0)  // Members logging below expected hours

  // Risk Signals
  lateLoggingCount            Int     @default(0)  // Members logging after 2+ days
  zeroHourDaysCount           Int     @default(0)  // Instances of 0h days
  weekendLoggingCount         Int     @default(0)  // Members logging on weekends

  // Metadata
  totalMembers                Int     @default(0)
  activeMembersCount          Int     @default(0)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([periodType, periodStart])
  @@index([periodType])
  @@index([periodStart])
}

// Member KPI Summary - Individual accountability and capacity metrics
model MemberKPISummary {
  id              String        @id @default(cuid())

  // Member reference
  teamMemberId    String
  teamMember      TeamMember    @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  // Period identification
  periodType      String        // "DAILY", "WEEKLY", "MONTHLY"
  periodStart     DateTime
  periodEnd       DateTime

  // Accountability KPIs
  attendanceCompliance        Boolean @default(false)  // Was present on expected days
  timesheetCompliance         Boolean @default(false)  // Logged min hours on expected days
  presentNotLogged            Boolean @default(false)  // Present but didn't log time
  attendanceDays              Int     @default(0)      // Days marked present
  expectedWorkDays            Int     @default(0)      // Expected work days in period

  // Capacity KPIs
  utilization                 Float   @default(0)      // (Logged / Expected) * 100
  utilizationStatus           String  @default("UNKNOWN") // "UNDER", "HEALTHY", "OVER"
  totalHoursLogged            Float   @default(0)
  expectedHours               Float   @default(0)

  // Risk Signals
  lateLoggingDays             Int     @default(0)      // Days logged after 2+ days
  zeroHourDays                Int     @default(0)      // Days with 0 hours
  weekendLoggingDays          Int     @default(0)      // Weekend days with logging
  consecutiveZeroDays         Int     @default(0)      // Max consecutive 0h days

  // Risk Flags
  hasLateLoggingRisk          Boolean @default(false)
  hasZeroHourRisk             Boolean @default(false)
  hasWeekendRisk              Boolean @default(false)
  hasBurnoutRisk              Boolean @default(false)  // Over capacity + weekend logging

  // Insights
  riskLevel                   String  @default("LOW")  // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  actionRequired              String? // Suggested action

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([teamMemberId, periodType, periodStart])
  @@index([teamMemberId])
  @@index([periodType])
  @@index([periodStart])
  @@index([riskLevel])
}

// Insights - Narrative layer for KPIs
model Insight {
  id              String        @id @default(cuid())

  // Scope
  scope           String        // "TEAM", "MEMBER", "DEPARTMENT"
  scopeId         String?       // Team member ID if member-specific

  // Period
  periodType      String        // "DAILY", "WEEKLY", "MONTHLY"
  periodStart     DateTime
  periodEnd       DateTime

  // Insight details
  category        String        // "ACCOUNTABILITY", "CAPACITY", "RISK", "GENERAL"
  severity        String        // "INFO", "WARNING", "CRITICAL"
  title           String        // Short title
  description     String        // Detailed explanation

  // Metrics referenced
  metrics         String?       // JSON object with relevant metrics

  // Actions
  suggestedActions String?      // JSON array of suggested actions

  // Status
  acknowledged    Boolean       @default(false)
  acknowledgedAt  DateTime?
  acknowledgedBy  String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([scope])
  @@index([periodStart])
  @@index([category])
  @@index([severity])
  @@index([acknowledged])
}
